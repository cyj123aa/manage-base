<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hoolink.manage.base.dao.mapper.ext.MiddleUserDepartmentMapperExt">

  <insert id="batchInsert" parameterType="java.util.List">
    insert into middle_user_department (user_id, dept_id, encry_level_dept, diff_dept_group, deduce_status
      )
    values
    <foreach collection="middleUserDeptList" item="userDeptPair" separator=",">
      (#{userDeptPair.userId},#{userDeptPair.deptId},#{userDeptPair.encryLevelDept},#{userDeptPair.diffDeptGroup}, #{userDeptPair.deduceStatus})
    </foreach>
  </insert>

  <resultMap id="UserCompanyMap" type="com.hoolink.manage.base.bo.DeptPositionBO">
    <id column="id" jdbcType="BIGINT" property="id"/>
    <result column="dept_name" jdbcType="VARCHAR" property="deptName"/>
    <result column="dept_type" jdbcType="TINYINT" property="deptType"/>
    <result column="parent_id" jdbcType="BIGINT" property="parentId"/>
    <result column="encry_level_dept" jdbcType="TINYINT" property="encryLevelDept"/>
  </resultMap>

  <resultMap id="UserDeptMap" type="com.hoolink.manage.base.bo.UserDeptBO">
    <id column="id" jdbcType="BIGINT" property="deptId"/>
    <result column="dept_name" jdbcType="VARCHAR" property="deptName"/>
    <result column="encry_level_dept" jdbcType="TINYINT" property="encryLevelDept"/>
  </resultMap>

  <resultMap id="UserDeptAssociationMap" type="com.hoolink.sdk.bo.manager.UserDeptAssociationBO">
    <id column="dept_id" jdbcType="BIGINT" property="deptId"/>
    <result column="dept_name" jdbcType="VARCHAR" property="deptName"/>
    <result column="dept_type" jdbcType="TINYINT" property="deptType"/>
  </resultMap>

  <select id="getDept" resultMap="UserCompanyMap">
    select md.id,md.dept_name,md.dept_type,md.parent_id,mud.encry_level_dept from  middle_user_department mud
    left join manage_department md on mud.dept_id=md.id
    where mud.user_id=#{userId}
    and md.enabled=true
    order by md.created asc
  </select>

  <resultMap id="UserDeptInfoMap" type="com.hoolink.manage.base.bo.UserSecurityBO">
    <id column="id" jdbcType="BIGINT" property="id"/>
    <result column="encry_level_company" jdbcType="INTEGER" property="encryLevelCompany"/>
    <collection property="list" ofType="com.hoolink.manage.base.bo.DeptSecurityBO">
      <id column="dept_id" jdbcType="BIGINT" property="id" />
      <result column="encry_level_dept" jdbcType="INTEGER" property="encryLevelDept" />
      <result column="dept_type" jdbcType="TINYINT" property="deptType" />
      <result column="parent_id" jdbcType="BIGINT" property="parentId" />
    </collection>
  </resultMap>

  <select id="getUserSecurity" resultMap="UserDeptInfoMap">
    select mu.id,mu.encry_level_company,mud.dept_id,mud.encry_level_dept,md.dept_type,md.parent_id from manage_user mu
    left join middle_user_department mud on mu.id=mud.user_id
    left join manage_department md on mud.dept_id=md.id
    where mu.enabled=true and mu.id=#{userId} and md.dept_type!=1
  </select>

  <select id="getUserDept" resultMap="UserDeptMap">
  SELECT
	md.id,
	md.dept_name,
	mud.encry_level_dept
FROM
	middle_user_department mud
	LEFT JOIN manage_department md ON mud.dept_id = md.id
WHERE
	mud.user_id = #{userId}
	AND md.dept_type = #{deptType}
	AND md.enabled = TRUE
ORDER BY
	md.created ASC
  </select>

  <select id="getOrganizationInfo" resultMap="UserDeptAssociationMap">
    SELECT
      md.id AS dept_id,
      md.dept_name,
      md.dept_type
    FROM
      middle_user_department mud
      LEFT JOIN manage_department md ON mud.dept_id=md.id
    WHERE
      mud.user_id=#{userId}
    AND md.enabled=true
  </select>
  <select id="getDeptMenu" resultMap="UserDeptMap">
    select mu.company,mu.id,mu.dept_name from manage_user mu left join middle_user_department mud
    on mu.id=mud.user_id
    where mu.enabled=true and mu.id=#{user_id}
  </select>

</mapper>