<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hoolink.manage.base.dao.mapper.ext.ManageDepartmentMapperExt">

  <resultMap id="BaseResultMap" type="com.hoolink.sdk.bo.manager.ManageDepartmentTreeBO">
    <id column="id" jdbcType="BIGINT" property="key" />
    <result column="dept_name" jdbcType="VARCHAR" property="title" />
    <result column="dept_type" jdbcType="TINYINT" property="deptType" />
    <result column="parent_id" jdbcType="BIGINT" property="parentId" />
    <collection property="children" select="getOrganizationListByParentId" column="id"></collection>
  </resultMap>

    <!-- 获取所在公司或者部门-->
    <select id="getOrganizationList" resultMap="BaseResultMap">
        SELECT
            id,
            dept_name,
            dept_type,
            parent_id
        FROM
            manage_department md
        WHERE
            md.enabled = TRUE
            <if test="ids != null">
                AND md.id IN
                <foreach collection="ids" item="id" index="index" open="(" close=")" separator=",">
                    #{id}
                </foreach>
            </if>
    </select>

    <!-- 再递归查询所在公司或者部门下的所有字部门-->
    <select id="getOrganizationListByParentId" resultMap="BaseResultMap">
        SELECT
            id,
            dept_name,
            dept_type,
            parent_id
        FROM
            manage_department md
        WHERE
            md.enabled = TRUE
            AND md.parent_id = #{id}
    </select>

    <resultMap id="BasicBaseResultMap" type="com.hoolink.manage.base.dao.model.ManageDepartment">
        <id column="mp.id" jdbcType="BIGINT" property="id" />
        <result column="mc.id" jdbcType="BIGINT" property="parentId" />
    </resultMap>

    <select id="getPositionByCompany" resultMap="BasicBaseResultMap">
        SELECT mp.id,mc.id
        FROM manage_department mp left join manage_department md on mp.parent_id = md.id and mp.enabled=true and md.enabled=true
        left join manage_department mc on md.parent_id = mc.id and mc.enabled=true
        WHERE
        mc.id IN
        <foreach collection="ids" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </select>

</mapper>